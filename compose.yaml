# For now this compose file is strictly for testing the server locally

services:
  postgres:
    container_name: danceblue-app-database-${SUBDOMAIN:?error}
    image: postgres:16
    environment:
      POSTGRES_USER: danceblue
      POSTGRES_PASSWORD: danceblue
      POSTGRES_DB: danceblue
    attach: false
    volumes:
      - danceblue-app-server-${SUBDOMAIN:?error}-database:/var/lib/postgresql/data
  server:
    container_name: danceblue-app-server-${SUBDOMAIN:?error}
    build:
      context: .
      dockerfile: ./packages/server/Dockerfile
    networks:
      - proxy
    links:
      - postgres
    depends_on:
      - postgres
    env_file: ./packages/server/.env
    environment:
      NODE_ENV: ${NODE_ENV:-production}
      APPLICATION_PORT: 8000
      MS_OIDC_URL: https://login.microsoftonline.com/2b30530b-69b6-4457-b818-481cb53d42ae/v2.0/.well-known/openid-configuration
      SERVE_PATH: /data/local-uploads
      UPLOAD_PATH: /data/local-uploads
      MAX_FILE_SIZE: 200
      LOG_DIR: /data/logs
      APPLICATION_HOST: danceblue-app-server-${SUBDOMAIN:?error}
      DATABASE_URL: postgres://danceblue:danceblue@postgres:5432/danceblue
    volumes:
      - danceblue-app-server-${SUBDOMAIN:?error}-content:/data/local-uploads
  portal:
    container_name: danceblue-app-portal-${SUBDOMAIN:?error}
    networks:
      - proxy
    build:
      context: ./packages/portal
      dockerfile: ./packages/portal/Dockerfile

networks:
  database:
    internal: true
  proxy:
    external: true
    name: proxy

volumes:
  "danceblue-app-server-${SUBDOMAIN:?error}-content":
    driver: local
  "danceblue-app-server-${SUBDOMAIN:?error}-database":
    driver: local
